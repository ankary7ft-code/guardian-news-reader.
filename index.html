<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Guardian Reader</title>
    
    <!-- iOS WEB APP CONFIGURATION -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Guardian News">
    
    <!-- APP ICON - HIGH RES (180x180) -->
    <!-- Switching to the larger 180px version forces the iPhone to re-download the icon -->
    <link rel="apple-touch-icon" href="https://assets.guim.co.uk/images/favicons/451963ac2c236334721983b451963ac2/180x180.png">
    <link rel="icon" href="https://assets.guim.co.uk/images/favicons/451963ac2c236334721983b451963ac2/180x180.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Mobile Safe Areas */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Icon = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></Icon>;
        const Newspaper = (props) => <Icon {...props}><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"></path><path d="M18 14h-8"></path><path d="M15 18h-5"></path><path d="M10 6h8v4h-8V6Z"></path></Icon>;
        const Loader = (props) => <Icon {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></Icon>;
        const AlertCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></Icon>;
        const X = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></Icon>;
        const ChevronRight = (props) => <Icon {...props}><polyline points="9 18 15 12 9 6"></polyline></Icon>;
        const Key = (props) => <Icon {...props}><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"></path></Icon>;
        const Sparkles = (props) => <Icon {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></Icon>;
        const Bot = (props) => <Icon {...props}><rect width="18" height="10" x="3" y="11" rx="2"></rect><circle cx="12" cy="5" r="2"></circle><path d="M12 7v4"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="16" y1="16" x2="16" y2="16"></line></Icon>;
        const ExternalLink = (props) => <Icon {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></Icon>;

        function GuardianViewer() {
            // --- State ---
            const [guardianApiKey, setGuardianApiKey] = useState('50683ee4-f106-4652-9fbf-14c8b1914356');
            const [geminiApiKey, setGeminiApiKey] = useState('');
            
            const [tempGuardianKey, setTempGuardianKey] = useState('50683ee4-f106-4652-9fbf-14c8b1914356');
            const [tempGeminiKey, setTempGeminiKey] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            
            const [query, setQuery] = useState('');
            const [articles, setArticles] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [section, setSection] = useState('world');

            const [activeArticle, setActiveArticle] = useState(null);
            const [insightModalOpen, setInsightModalOpen] = useState(false);
            const [geminiContent, setGeminiContent] = useState('');
            const [geminiLoading, setGeminiLoading] = useState(false);
            const [globalPulse, setGlobalPulse] = useState(null);
            const [pulseLoading, setPulseLoading] = useState(false);

            const sections = [
                { id: '', label: 'All News' },
                { id: 'world', label: 'World' },
                { id: 'politics', label: 'Politics' },
                { id: 'technology', label: 'Tech' },
                { id: 'sport', label: 'Sport' },
                { id: 'business', label: 'Business' },
                { id: 'culture', label: 'Culture' },
                { id: 'environment', label: 'Environment' },
            ];

            // --- Fetching Logic ---
            const fetchArticles = async (searchQuery = '', sectionFilter = '') => {
                const keyToUse = guardianApiKey || 'test'; 
                setLoading(true);
                setError(null);
                setGlobalPulse(null);

                try {
                    const baseUrl = 'https://content.guardianapis.com/search';
                    const params = new URLSearchParams({
                        'api-key': keyToUse,
                        'show-fields': 'thumbnail,headline,trailText,byline,lastModified',
                        'page-size': '15',
                        'order-by': 'newest'
                    });

                    if (searchQuery) params.append('q', searchQuery);
                    if (sectionFilter) params.append('section', sectionFilter);

                    const response = await fetch(`${baseUrl}?${params.toString()}`);
                    const data = await response.json();

                    if (response.ok && data.response && data.response.status === 'ok') {
                        setArticles(data.response.results);
                        if (data.response.results.length === 0) setError('No articles found.');
                    } else {
                        throw new Error('Failed to fetch news.');
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { fetchArticles(query, section); }, [section]); 

            // --- AI Logic ---
            const generateDeepDive = async (article) => {
                if (!geminiApiKey) { setShowSettings(true); alert("Enter Gemini Key first."); return; }
                setActiveArticle(article); setInsightModalOpen(true); setGeminiLoading(true); setGeminiContent('');
                const prompt = `Analyze article: "${article.webTitle}". Snippet: "${article.fields?.trailText}". 1. Background Context (2 sentences). 2. Why It Matters (2 bullets).`;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    setGeminiContent(data.candidates?.[0]?.content?.parts?.[0]?.text || "Error generating.");
                } catch (e) { setGeminiContent("Connection error."); } finally { setGeminiLoading(false); }
            };

            const generateGlobalPulse = async () => {
                if (!geminiApiKey) { setShowSettings(true); alert("Enter Gemini Key first."); return; }
                setPulseLoading(true);
                const headlines = articles.slice(0, 10).map(a => `- ${a.webTitle}`).join('\n');
                const prompt = `News headlines:\n${headlines}\nSummarize mood/themes in 3 sentences with an emoji start.`;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    setGlobalPulse(data.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch (e) { setGlobalPulse("Error."); } finally { setPulseLoading(false); }
            };

            const formatDate = (d) => new Date(d).toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
            const formatGeminiText = (text) => {
                if (!text) return null;
                return text.split('\n').map((line, i) => <p key={i} className="mb-2">{line}</p>);
            };

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 font-sans selection:bg-blue-100 pb-12 safe-top safe-bottom">
                    {/* Header */}
                    <header className="bg-[#052962] text-white sticky top-0 z-40 shadow-md">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center space-x-3 cursor-pointer" onClick={() => {setQuery(''); setSection('world');}}>
                                    <div className="bg-white text-[#052962] p-1.5 rounded"><Newspaper size={24} strokeWidth={2.5} /></div>
                                    <h1 className="text-xl font-bold tracking-tight block">The Guardian</h1>
                                </div>
                                <button onClick={() => setShowSettings(!showSettings)} className={`p-2 rounded-full transition-colors ${showSettings ? 'bg-yellow-400 text-[#052962]' : 'hover:bg-[#1a3d75]'}`}><Key size={20} /></button>
                            </div>
                        </div>
                        <div className="bg-[#041f4a] border-t border-[#1a3d75] overflow-x-auto no-scrollbar">
                            <div className="max-w-7xl mx-auto px-4 flex items-center space-x-6 text-sm font-medium">
                                {sections.map((sec) => (
                                    <button key={sec.id} onClick={() => setSection(sec.id)} className={`py-3 border-b-2 whitespace-nowrap transition-colors ${section === sec.id ? 'border-yellow-400 text-yellow-400' : 'border-transparent text-gray-300 hover:text-white'}`}>{sec.label}</button>
                                ))}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 relative">
                         {/* Search (Mobile Friendly) */}
                        <form onSubmit={(e) => {e.preventDefault(); fetchArticles(query, section);}} className="flex gap-2 mb-6">
                            <input type="text" placeholder="Search news..." className="flex-1 bg-white border border-slate-200 rounded-lg px-4 py-3 shadow-sm outline-none focus:ring-2 focus:ring-blue-500" value={query} onChange={(e) => setQuery(e.target.value)} />
                            <button type="submit" className="bg-[#052962] text-white px-4 py-2 rounded-lg"><Search size={20} /></button>
                        </form>

                        {/* Settings */}
                        {showSettings && (
                            <div className="mb-8 bg-white border border-blue-100 rounded-xl shadow-sm p-6 fade-in">
                                <div className="flex justify-between items-start mb-4">
                                    <h2 className="text-lg font-bold text-[#052962]">Keys</h2>
                                    <button onClick={() => setShowSettings(false)} className="text-slate-400"><X size={20} /></button>
                                </div>
                                <div className="grid gap-4 max-w-lg">
                                    <div><label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Guardian Key</label><input type="text" value={tempGuardianKey} onChange={(e) => setTempGuardianKey(e.target.value)} className="w-full border border-slate-300 rounded-lg px-4 py-2" /></div>
                                    <div><label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Gemini Key</label><input type="password" value={tempGeminiKey} onChange={(e) => setTempGeminiKey(e.target.value)} className="w-full border border-slate-300 rounded-lg px-4 py-2" /></div>
                                    <button onClick={() => {setGuardianApiKey(tempGuardianKey); setGeminiApiKey(tempGeminiKey); setShowSettings(false);}} className="bg-[#052962] text-white px-6 py-2 rounded-lg font-medium mt-2">Save</button>
                                </div>
                            </div>
                        )}

                        {/* Pulse Feature */}
                        {!loading && !error && articles.length > 0 && (
                            <div className="mb-8">
                                {!globalPulse && !pulseLoading ? (
                                    <button onClick={generateGlobalPulse} className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white p-4 rounded-xl shadow-sm flex items-center justify-center gap-2 transition-all transform hover:scale-[1.01]"><Sparkles size={20} className="text-yellow-300" /><span className="font-semibold">Generate Global Pulse</span></button>
                                ) : (
                                    <div className="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-100 p-6 rounded-xl shadow-sm flex gap-4">
                                        {pulseLoading ? <div className="flex items-center gap-3 text-indigo-700 w-full justify-center"><Loader className="animate-spin" size={20} /><span>Analyzing...</span></div> : (
                                            <><div className="bg-indigo-100 p-3 rounded-full h-fit shrink-0"><Bot size={24} className="text-indigo-600" /></div><div><h3 className="text-indigo-900 font-bold mb-1">Global Pulse</h3><p className="text-indigo-800 leading-relaxed">{globalPulse}</p></div></>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Error & Loading */}
                        {error && <div className="text-center py-12"><div className="bg-red-50 text-red-600 p-4 rounded-full mb-4 inline-block"><AlertCircle size={32} /></div><p className="text-slate-500">{error}</p></div>}
                        {loading && <div className="flex justify-center py-20"><Loader className="animate-spin text-[#052962]" size={40} /></div>}

                        {/* Article List */}
                        {!loading && !error && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {articles.map((article) => (
                                    <article key={article.id} className="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden flex flex-col h-full">
                                        <div className="relative h-48 bg-slate-100">
                                            {article.fields?.thumbnail ? <img src={article.fields.thumbnail} alt={article.webTitle} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center"><Newspaper size={48} className="text-slate-300" /></div>}
                                        </div>
                                        <div className="p-5 flex flex-col flex-1">
                                            <div className="text-xs text-slate-500 font-medium mb-2">{formatDate(article.webPublicationDate)}</div>
                                            <h2 className="text-lg font-bold text-[#052962] mb-2 leading-tight"><a href={article.webUrl} target="_blank" className="block">{article.webTitle}</a></h2>
                                            <div className="pt-4 mt-auto flex justify-between items-center">
                                                <button onClick={() => generateDeepDive(article)} className="text-xs font-bold text-purple-600 bg-purple-50 px-3 py-1.5 rounded-full flex gap-1"><Sparkles size={14} /> AI Insight</button>
                                                <a href={article.webUrl} target="_blank" className="text-xs font-bold text-[#052962] uppercase flex items-center">Read <ChevronRight size={14} /></a>
                                            </div>
                                        </div>
                                    </article>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* Insight Modal */}
                    {insightModalOpen && activeArticle && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 bg-black/40 backdrop-blur-sm fade-in">
                            <div className="bg-white w-full sm:max-w-2xl sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                                <div className="bg-[#052962] text-white p-4 flex justify-between items-start">
                                    <div><div className="flex items-center gap-2 text-yellow-400 mb-1"><Sparkles size={16} /><span className="text-[10px] font-bold uppercase tracking-widest">Gemini</span></div><h3 className="text-md font-bold leading-tight line-clamp-1">{activeArticle.webTitle}</h3></div>
                                    <button onClick={() => setInsightModalOpen(false)} className="text-white/70 p-1"><X size={20} /></button>
                                </div>
                                <div className="p-6 overflow-y-auto">{geminiLoading ? <div className="flex flex-col items-center justify-center py-12"><Loader className="animate-spin text-purple-600" size={32} /></div> : <div className="space-y-4 text-sm leading-relaxed">{formatGeminiText(geminiContent)}</div>}</div>
                                <div className="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3 safe-bottom"><button onClick={() => setInsightModalOpen(false)} className="px-4 py-2 text-slate-600 font-medium">Close</button><a href={activeArticle.webUrl} target="_blank" className="px-4 py-2 bg-[#052962] text-white rounded-lg font-medium flex items-center gap-2">Read <ExternalLink size={14} /></a></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GuardianViewer />);
    </script>
</body>
</html>